{
  "title": "JSON schema for Clowder configuration files",
  "$id": "http://json.schemastore.org/clowder",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "definitions": {
    "nonEmptyString": {
      "type": "string",
      "minLength": 1
    },
    "nonEmptyStringNoSpaces": {
      "type": "string",
      "minLength": 1,
      "pattern": "^((?! ).)*$"
    },
    "clowderName": {
      "type": "string",
      "minLength": 1,
      "pattern": "[a-zA-Z0-9-_]+"
    },
    "projectGroup": {
      "type": "string",
      "minLength": 1,
      "pattern": "^(?!default|all$)[a-zA-Z0-9-_]*$"
    },
    "projectGroups": {
      "type": "array",
      "uniqueItems": true,
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/projectGroup"
      }
    },
    "relativePath": {
      "description": "Relative file system path",
      "type": "string",
      "minLength": 1,
      "pattern": "^(?!\/.*$).*"
    },
    "gitConfigVariableName": {
      "description": "Fully qualified git config variable name",
      "type": "string",
      "minLength": 1,
      "pattern": "^[a-zA-Z][a-zA-Z0-9-]*[.]([^\n]+[.]){0,1}[a-zA-Z][a-zA-Z0-9-]*$"
    },
    "gitConfigVariableValue": {
      "description": "Git config variable value",
      "oneOf": [
        {
          "$ref": "#/definitions/nonEmptyString"
        },
        {
          "type": "number"
        },
        {
          "type": "boolean"
        },
        {
          "type": "null"
        }
      ]
    },
    "gitConfigProject": {
      "description": "Project git config settings",
      "type": "object",
      "minProperties": 1,
      "propertyNames": {
        "$ref": "#/definitions/gitConfigVariableName"
      },
      "additionalProperties": {
        "$ref": "#/definitions/gitConfigVariableValue"
      }
    },
    "gitConfigDefault": {
      "description": "Defaults git config settings",
      "type": "object",
      "minProperties": 1,
      "propertyNames": {
        "$ref": "#/definitions/gitConfigVariableName"
      },
      "additionalProperties": {
        "$ref": "#/definitions/gitConfigVariableValue"
      }
    },
    "gitSettingsDefault": {
      "description": "Git settings",
      "type": "object",
      "minProperties": 1,
      "additionalProperties": false,
      "properties": {
        "lfs": {
          "$ref": "#/definitions/lfsDefault"
        },
        "recursive": {
          "$ref": "#/definitions/recursiveDefault"
        },
        "depth": {
          "$ref": "#/definitions/depthDefault"
        },
        "config": {
          "$ref": "#/definitions/gitConfigDefault"
        }
      }
    },
    "gitSettingsProject": {
      "description": "Git settings",
      "type": "object",
      "minProperties": 1,
      "additionalProperties": false,
      "properties": {
        "lfs": {
          "$ref": "#/definitions/lfsProject"
        },
        "recursive": {
          "$ref": "#/definitions/recursiveProject"
        },
        "depth": {
          "$ref": "#/definitions/depthProject"
        },
        "config": {
          "$ref": "#/definitions/gitConfigProject"
        }
      }
    },
    "projectName": {
      "description": "A unique name for this project. The project's name is appended onto its source's URL to generate the actual URL to configure the Git remote with. The URL gets formed as: ${source_url}/${project_name}.git where ${source_url} is the source's url and ${project_name} is the project’s name. The suffix '.git' is always appended as clowder assumes the upstream is a forest of bare Git repositories.",
      "oneOf": [
        {
          "$ref": "#/definitions/nonEmptyStringNoSpaces"
        }
      ]
    },
    "forkName": {
      "description": "A unique name for this project. The project's name is appended onto its source's URL to generate the actual URL to configure the Git remote with. The URL gets formed as: ${source_url}/${project_name}.git where ${source_url} is the source's url and ${project_name} is the project’s name. The suffix '.git' is always appended as clowder assumes the upstream is a forest of bare Git repositories.",
      "oneOf": [
        {
          "$ref": "#/definitions/nonEmptyStringNoSpaces"
        }
      ]
    },
    "sourceNameDefault": {
      "description": "Git source name",
      "oneOf": [
        {
          "$ref": "#/definitions/nonEmptyStringNoSpaces"
        }
      ]
    },
    "sourceNameProject": {
      "description": "Git source name",
      "oneOf": [
        {
          "$ref": "#/definitions/nonEmptyStringNoSpaces"
        }
      ]
    },
    "sourceNameFork": {
      "description": "Git source name",
      "oneOf": [
        {
          "$ref": "#/definitions/nonEmptyStringNoSpaces"
        }
      ]
    },
    "remoteNameProject": {
      "description": "The name specified here is used as the remote name in each project's .git/config, and is therefore automatically available to commands like git fetch, git remote, git pull and git push.",
      "oneOf": [
        {
          "$ref": "#/definitions/nonEmptyStringNoSpaces"
        }
      ]
    },
    "remoteNameFork": {
      "description": "The name specified here is used as the remote name in each project's .git/config, and is therefore automatically available to commands like git fetch, git remote, git pull and git push.",
      "oneOf": [
        {
          "$ref": "#/definitions/nonEmptyStringNoSpaces"
        }
      ]
    },
    "remoteNameDefault": {
      "description": "The name specified here is used as the remote name in each project's .git/config, and is therefore automatically available to commands like git fetch, git remote, git pull and git push.",
      "oneOf": [
        {
          "$ref": "#/definitions/nonEmptyStringNoSpaces"
        }
      ]
    },
    "depthDefault": {
      "description": "Git clone depth",
      "type": "integer",
      "minimum": 0,
      "default": 0
    },
    "depthProject": {
      "description": "Git clone depth",
      "type": "integer",
      "minimum": 0,
      "default": 0
    },
    "recursiveDefault": {
      "description": "Whether to clone and fetch project submodules recursively",
      "type": "boolean",
      "default": false
    },
    "recursiveProject": {
      "description": "Whether to clone and fetch project submodules recursively",
      "type": "boolean",
      "default": false
    },
    "lfsDefault": {
      "description": "Whether repository uses git lfs",
      "type": "boolean",
      "default": false
    },
    "lfsProject": {
      "description": "Whether repository uses git lfs",
      "type": "boolean",
      "default": false
    },
    "branchDefault": {
      "description": "Name of the Git branch to track for this project. If not supplied the ref specified in the defaults is used if applicable, else the default branch 'master' is used.",
      "oneOf": [
        {
          "$ref": "#/definitions/nonEmptyStringNoSpaces"
        }
      ]
    },
    "branchProject": {
      "description": "Name of the Git branch to track for this project. If not supplied the ref specified in the defaults is used if applicable, else the default branch 'master' is used.",
      "oneOf": [
        {
          "$ref": "#/definitions/nonEmptyStringNoSpaces"
        }
      ]
    },
    "branchFork": {
      "description": "Name of the Git branch to track for this project. If not supplied the ref specified in the defaults is used if applicable, else the default branch 'master' is used.",
      "oneOf": [
        {
          "$ref": "#/definitions/nonEmptyStringNoSpaces"
        }
      ]
    },
    "tagDefault": {
      "description": "Name of the Git tag to track for this project. If not supplied the ref specified in the defaults is used if applicable, else the default branch 'master' is used.",
      "oneOf": [
        {
          "$ref": "#/definitions/nonEmptyStringNoSpaces"
        }
      ]
    },
    "tagProject": {
      "description": "Name of the Git tag to track for this project. If not supplied the ref specified in the defaults is used if applicable, else the default branch 'master' is used.",
      "oneOf": [
        {
          "$ref": "#/definitions/nonEmptyStringNoSpaces"
        }
      ]
    },
    "tagFork": {
      "description": "Name of the Git tag to track for this project. If not supplied the ref specified in the defaults is used if applicable, else the default branch 'master' is used.",
      "oneOf": [
        {
          "$ref": "#/definitions/nonEmptyStringNoSpaces"
        }
      ]
    },
    "commitDefault": {
      "description": "Git commit SHA-1 to track for this project. Must be full 40 character SHA-1. If not supplied the ref specified in the defaults is used if applicable, else the default branch 'master' is used.",
      "type": "string",
      "pattern": "[a-fA-F0-9]{40}"
    },
    "commitProject": {
      "description": "Git commit SHA-1 to track for this project. Must be full 40 character SHA-1. If not supplied the ref specified in the defaults is used if applicable, else the default branch 'master' is used.",
      "type": "string",
      "pattern": "[a-fA-F0-9]{40}"
    },
    "commitFork": {
      "description": "Git commit SHA-1 to track for this project. Must be full 40 character SHA-1. If not supplied the ref specified in the defaults is used if applicable, else the default branch 'master' is used.",
      "type": "string",
      "pattern": "[a-fA-F0-9]{40}"
    },
    "protocolDefault": {
      "description": "The Git URL protocol prefix for all projects which use this remote source. Each project's source url and name are appended to this prefix to form the actual URL used to clone the project. Accepted values are 'ssh' or 'https', forming URL's of the form 'git@${remote_url}:${project_name}.git' or 'https://${remote_url}/${project_name}.git', respectively.",
      "type": "string",
      "enum": [
        "https",
        "ssh"
      ]
    },
    "protocolSource": {
      "description": "The Git URL protocol prefix for all projects which use this remote source. Each project's source url and name are appended to this prefix to form the actual URL used to clone the project. Accepted values are 'ssh' or 'https', forming URL's of the form 'git@${remote_url}:${project_name}.git' or 'https://${remote_url}/${project_name}.git', respectively.",
      "type": "string",
      "enum": [
        "https",
        "ssh"
      ]
    },
    "source": {
      "description": "A map defining a git repository source",
      "type": "object",
      "required": [
        "name",
        "url"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "description": "Unique name of git repository's remote source",
          "oneOf": [
            {
              "$ref": "#/definitions/nonEmptyStringNoSpaces"
            }
          ]
        },
        "url": {
          "description": "The Git URL prefix for all projects which use this source. Each project's name is appended to this prefix to form the actual URL used to clone the project.",
          "oneOf": [
            {
              "$ref": "#/definitions/nonEmptyStringNoSpaces"
            }
          ]
        },
        "protocol": {
          "$ref": "#/definitions/protocolSource"
        }
      }
    },
    "fork": {
      "description": "A map defining a fork",
      "type": "object",
      "anyOf": [
        {
          "additionalProperties": false,
          "required": [
            "name"
          ],
          "properties": {
            "name": {
              "$ref": "#/definitions/forkName"
            },
            "source": {
              "$ref": "#/definitions/sourceNameFork"
            },
            "branch": {
              "$ref": "#/definitions/branchFork"
            },
            "remote": {
              "$ref": "#/definitions/remoteNameFork"
            }
          }
        },
        {
          "additionalProperties": false,
          "required": [
            "name"
          ],
          "properties": {
            "name": {
              "$ref": "#/definitions/forkName"
            },
            "source": {
              "$ref": "#/definitions/sourceNameFork"
            },
            "tag": {
              "$ref": "#/definitions/tagFork"
            },
            "remote": {
              "$ref": "#/definitions/remoteNameFork"
            }
          }
        },
        {
          "additionalProperties": false,
          "required": [
            "name"
          ],
          "properties": {
            "name": {
              "$ref": "#/definitions/forkName"
            },
            "source": {
              "$ref": "#/definitions/sourceNameFork"
            },
            "commit": {
              "$ref": "#/definitions/commitFork"
            },
            "remote": {
              "$ref": "#/definitions/remoteNameFork"
            }
          }
        }
      ]
    },
    "project": {
      "description": "A map defining a project",
      "type": "object",
      "anyOf": [
        {
          "additionalProperties": false,
          "required": [
            "name"
          ],
          "properties": {
            "name": {
              "$ref": "#/definitions/projectName"
            },
            "path": {
              "description": "Path to clone project on disk",
              "oneOf": [
                {
                  "$ref": "#/definitions/relativePath"
                }
              ]
            },
            "source": {
              "$ref": "#/definitions/sourceNameProject"
            },
            "branch": {
              "$ref": "#/definitions/branchProject"
            },
            "remote": {
              "$ref": "#/definitions/remoteNameProject"
            },
            "groups": {
              "description": "Groups project belongs to",
              "oneOf": [
                {
                  "$ref": "#/definitions/projectGroups"
                }
              ]
            },
            "fork": {
              "$ref": "#/definitions/fork"
            },
            "git": {
              "$ref": "#/definitions/gitSettingsProject"
            }
          }
        },
        {
          "additionalProperties": false,
          "required": [
            "name"
          ],
          "properties": {
            "name": {
              "$ref": "#/definitions/projectName"
            },
            "path": {
              "description": "Path to clone project on disk",
              "oneOf": [
                {
                  "$ref": "#/definitions/relativePath"
                }
              ]
            },
            "source": {
              "$ref": "#/definitions/sourceNameProject"
            },
            "tag": {
              "$ref": "#/definitions/tagProject"
            },
            "remote": {
              "$ref": "#/definitions/remoteNameProject"
            },
            "groups": {
              "description": "Groups project belongs to",
              "oneOf": [
                {
                  "$ref": "#/definitions/projectGroups"
                }
              ]
            },
            "fork": {
              "$ref": "#/definitions/fork"
            },
            "git": {
              "$ref": "#/definitions/gitSettingsProject"
            }
          }
        },
        {
          "additionalProperties": false,
          "required": [
            "name"
          ],
          "properties": {
            "name": {
              "$ref": "#/definitions/projectName"
            },
            "path": {
              "description": "Path to clone project on disk",
              "oneOf": [
                {
                  "$ref": "#/definitions/relativePath"
                }
              ]
            },
            "source": {
              "$ref": "#/definitions/sourceNameProject"
            },
            "commit": {
              "$ref": "#/definitions/commitProject"
            },
            "remote": {
              "$ref": "#/definitions/remoteNameProject"
            },
            "groups": {
              "description": "Groups project belongs to",
              "oneOf": [
                {
                  "$ref": "#/definitions/projectGroups"
                }
              ]
            },
            "fork": {
              "$ref": "#/definitions/fork"
            },
            "depth": {
              "$ref": "#/definitions/depthProject"
            },
            "git": {
              "$ref": "#/definitions/gitSettingsProject"
            }
          }
        }
      ]
    }
  },
  "type": "object",
  "additionalProperties": false,
  "required": [
    "name",
    "projects"
  ],
  "properties": {
    "name": {
      "description": "A name describing the projects. Must be a string containing any combination of letters, numbers, - or _",
      "oneOf": [
        {
          "$ref": "#/definitions/clowderName"
        }
      ]
    },
    "defaults": {
      "description": "Default values inherited by projects and sources",
      "type": "object",
      "anyOf": [
        {
          "minProperties": 1,
          "additionalProperties": false,
          "properties": {
            "source": {
              "$ref": "#/definitions/sourceNameDefault"
            },
            "branch": {
              "$ref": "#/definitions/branchDefault"
            },
            "remote": {
              "$ref": "#/definitions/remoteNameDefault"
            },
            "protocol": {
              "$ref": "#/definitions/protocolDefault"
            },
            "git": {
              "$ref": "#/definitions/gitSettingsDefault"
            }
          }
        },
        {
          "minProperties": 1,
          "additionalProperties": false,
          "properties": {
            "source": {
              "$ref": "#/definitions/sourceNameDefault"
            },
            "tag": {
              "$ref": "#/definitions/tagDefault"
            },
            "remote": {
              "$ref": "#/definitions/remoteNameDefault"
            },
            "protocol": {
              "$ref": "#/definitions/protocolDefault"
            },
            "git": {
              "$ref": "#/definitions/gitSettingsDefault"
            }
          }
        },
        {
          "minProperties": 1,
          "additionalProperties": false,
          "properties": {
            "source": {
              "$ref": "#/definitions/sourceNameDefault"
            },
            "commit": {
              "$ref": "#/definitions/commitDefault"
            },
            "remote": {
              "$ref": "#/definitions/remoteNameDefault"
            },
            "protocol": {
              "$ref": "#/definitions/protocolDefault"
            },
            "git": {
              "$ref": "#/definitions/gitSettingsDefault"
            }
          }
        }
      ]
    },
    "sources": {
      "description": "List of sources",
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/source"
      }
    },
    "projects": {
      "description": "List of projects",
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/project"
      }
    }
  }
}
